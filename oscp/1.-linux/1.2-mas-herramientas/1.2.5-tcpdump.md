# 1.2.5 Tcpdump

## Funciones básicas.

tcpdump una herramienta de análisis de red del mundo, que combina potencia y simplicidad en una única interfaz de línea de comandos.

Esta guía le mostrará cómo aislar el tráfico de varias maneras, incluso por IP, puerto, protocolo o aplicación para ayudarlo a encontrar lo que está buscando.

### Parámetros

* **`-X`** : Muestre el contenido del paquete tanto en hexadecimal como en ASCII.
* **`-XX`** : Igual que **`-X`**, pero también muestra el encabezado ethernet.
* **`-D`** : Mostrar la lista de interfaces disponibles&#x20;
* **`-l`** : Salida legible por línea (para ver mientras guarda o enviar a otros comandos)&#x20;
* **`-q`** : Sea menos detallado (más silencioso) con su salida.&#x20;
* **`-t`** : Muestra una salida más legible.&#x20;
* **`-tttt`** : Muestra una salida aun más legible.
* **`-i eth0`** : Escuchar en la interfaz eth0.&#x20;
* **`-w captura.pcap`** : Guardar lo capturado en un archivo .pcap.
* **`-vv`** : Salida detallada.&#x20;
* **`-c`** : Sólo obtener x número de paquetes y luego detenerse.&#x20;
* **`-s`** : Defina la longitud de ajuste (tamaño) de la captura en bytes. -s0 : para obtener todo, a menos que esté capturando intencionalmente menos.&#x20;
* **`-S`** : Imprimir números de secuencia absolutos.&#x20;
* **`-e`** : Obtenga el encabezado ethernet también.&#x20;
* **`-q`** : Mostrar menos información de protocolo.&#x20;
* **`-E`**: Descifrar el tráfico IPSEC proporcionando una clave de cifrado.

### Comunicación básica

Podemos capturar los paquetes de la siguiente manera seleccionando una interfaz.

> tcpdump -i eth0

{% hint style="info" %}
Capturar todas las interfaces **tcpdump -i any.**
{% endhint %}

### Encontrar tráfico por IP&#x20;

Una de las consultas más comunes, filtrando por host, puede ver el tráfico que va hacia o desde 10.10.10.10.

> tcpdump host 10.10.10.10

### Filtrar por origen y/o destino&#x20;

Si solo desea ver el tráfico en una dirección u otra, puede usar src y dst.

> tcpdump src 10.10.10.10
>
> tcpdump dst 10.10.10.11

### Búsqueda de paquetes por red

La salida hexadecimal es útil cuando desea ver el contenido de los paquetes.

> tcpdump net 1.2.3.0/24

{% hint style="info" %}
También puede combinar esto con las opciones src y dst.
{% endhint %}

### Obtener el contenido del paquete en formato hexadecimal.

La salida hexadecimal es útil cuando desea ver el contenido de los paquetes.

> tcpdump -c 1 -X icmp

### Mostrar el tráfico relacionado con un puerto específico

Puede encontrar tráfico de puerto específico utilizando la opción de puerto seguida del número de puerto.

> tcpdump port 3389
>
> tcpdump src port 1025

### Mostrar el tráfico de un protocolo

Si está buscando un tipo particular de tráfico, también puede usar tcp, udp, icmp y muchos otros.

> tcpdump icmp

### Muestre el tráfico ipv6&#x20;

También puede encontrar todo el tráfico IP6 utilizando la opción de protocolo.

> tcpdump ip6

### Encontrar tráfico usando rangos de puertos

También puede utilizar una serie de puertos para encontrar tráfico.

> tcpdump portrange 21-23

### Encontrar tráfico según el tamaño del paquete

Si está buscando paquetes de un tamaño particular, puede usar estas opciones. Puede usar menos, mayor o sus símbolos asociados que esperaría de las matemáticas.

> tcpdump less 32&#x20;
>
> tcpdump greater 64&#x20;
>
> tcpdump <= 128

### Escribir en un archivo

A menudo es útil guardar capturas de paquetes en un archivo para su análisis en el futuro. Estos archivos se conocen como archivos PCAP (PEE-cap), y pueden ser procesados por cientos de aplicaciones diferentes, incluidos analizadores de red, sistemas de detección de intrusiones y, por supuesto, por tcpdump. Aquí estamos escribiendo en un archivo llamado **captura** usando el parametro **`-w`**.

> tcpdump port 80 -w captura

Puede leer archivos PCAP mediante el modificador **`-r`**. Tenga en cuenta que puede utilizar todos los comandos normales dentro de tcpdump mientras lee en un archivo; solo está limitado por el hecho de que no puede capturar y procesar lo que ya no existe en el archivo.

> tcpdump -r capture\_file

## Funciones avanzadas

### Operadores lógicos

Ser capaz de hacer estas diversas cosas individualmente es poderoso, pero la verdadera magia de tcpdump proviene de la capacidad de combinar opciones de manera creativa para aislar exactamente lo que está buscando. Hay tres formas de hacer combinaciones, y si has estudiado programación, te resultarán bastante familiares.

* **AND** _`and`_ o `&&`
* **OR** _`or`_ o `||`
* **EXCEPT**_`not`_ o `!`

### Vista de salida en  RAW.

Utilice esta combinación para ver la salida detallada, sin resolución de nombres de host o números de puerto, utilizando números de secuencia absolutos y mostrando marcas de tiempo legibles por humanos.

> tcpdump -ttnnvvS

### Desde IP específica y destinado a un puerto específico

Encontremos todo el tráfico de 10.5.2.3 que va a cualquier host en el puerto 3389.

> tcpdump -nnvvS src 10.5.2.3 and dst port 3389

### De una red a otra

Busquemos todo el tráfico proveniente de 192.168.x.x yendo a las redes 10.x o 172.16.x.x, y estamos mostrando la salida hexadeci-nunca con resolución de nombre de host y un nivel de verbosidad adicional.

> tcpdump -nvX src net 192.168.0.0/16 and dst net 10.0.0.0/8 or 172.16.0.0/16

### Tráfico que no es ICMP que va a una IP específica

Esto nos mostrará todo el tráfico que va a 192.168.0.2 que no es ICMP.

> tcpdump dst 192.168.0.2 and src net and not icmp

### Tráfico de un host que no está en un puerto específico

Esto nos mostrará todo el tráfico de un host que no es tráfico SSH (asumiendo el uso predeterminado del puerto).

> tcpdump -vv src mars and not dst port 22

### Aislar banderas tcp

También puede utilizar filtros para aislar paquetes con indicadores TCP específicos establecidos.

Aísle los indicadores TCP RST.

> tcpdump 'tcp\[13] & 4!=0'&#x20;
>
> tcpdump 'tcp\[tcpflags] == tcp-rst'

Aísle los indicadores TCP SYN.

> tcpdump 'tcp\[13] & 4!=0'&#x20;
>
> tcpdump 'tcp\[tcpflags] == tcp-rst'

Aísle los paquetes que tienen establecidos los indicadores SYN y ACK.

> tcpdump 'tcp\[13]=18'

Aísle los indicadores TCP URG.

> tcpdump 'tcp\[13] & 32!=0'&#x20;
>
> tcpdump 'tcp\[tcpflags] == tcp-urg'

Aísle los indicadores TCP ACK.

> tcpdump 'tcp\[13] & 16!=0'&#x20;
>
> tcpdump 'tcp\[tcpflags] == tcp-ack'

Aísle los indicadores TCP PSH.

> tcpdump 'tcp\[13] & 8!=0'\
> tcpdump 'tcp\[tcpflags] == tcp-push'

Aísle los indicadores TCP FIN.

> tcpdump 'tcp\[13] & 1!=0'&#x20;
>
> tcpdump 'tcp\[tcpflags] == tcp-fin'

### Buscar HTTP User-Agent&#x20;

> tcpdump -vvAls0 | grep 'User-Agent:'

### Buscar texto sin formato http obtiene&#x20;

> tcpdump -vvAls0 | grep 'GET'

### Encontrar hosts http

> tcpdump -vvAls0 | grep 'Host:'

### Encontrar cookies http

> tcpdump -vvAls0 | grep 'Set-Cookie|Host:|Cookie:'

### Encontrar conexiones SSH

> tcpdump 'tcp\[(tcp\[12]>>2):4] = 0x5353482D'

### Encontrar tráfico dns&#x20;

> tcpdump -vvAs0 port 53

### Encontrar tráfico ftp

> tcpdump -vvAs0 port ftp or ftp-data

### Encontrar tráfico ntp

> tcpdump -vvAs0 port 123

### Encontrar contraseñas de texto sin cifrar

> tcpdump port http or port ftp or port smtp or port imap or port pop3 or port telnet -lA | egrep -i -B5 'pass=|pwd=|log=|login=|user=|username=|pw=|passw=|passwd= |password=|pass:|user:|username:|password:|login:|pass |user '
