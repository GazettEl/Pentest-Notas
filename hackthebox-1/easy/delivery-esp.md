---
description: 'https://www.hackthebox.eu/home/machines/profile/308'
---

# Delivery

Resumen: Maquina linux con dos puertos abiertos ssh:22, http:80 y 8065:unknown

![](../../.gitbook/assets/0%20%288%29.png)

## Enumeración

Realizamos un escaneo con nmap para saber los puertos abiertos en el rango de 1-65536 puertos.

```text
map -p- --open -n -T5 delivery.htb -oG allPorts
Starting Nmap 7.91 ( https://nmap.org ) at 2021-02-23 00:00 CST
Nmap scan report for delivery.htb (10.10.10.222)
Host is up (0.075s latency).
Not shown: 65532 closed ports
PORT STATE SERVICE
22/tcp open ssh
80/tcp open http
8065/tcp open unknown
Nmap done: 1 IP address (1 host up) scanned in 26.71 seconds
```

| Bandera | Descripción |
| :--- | :--- |
| -p- | Escaneo a los 65536 puertos |
| --open | Reporta solo los puertos con estado "open". |
| -T5 | Exploracion a velocidades insanas \(lo hago porque es un entorno de pruebas\). |
| -v | Muestra más información sobre el sondeo que se está realizando. |
| -oG allPorts | Exporta los resultados en un formato Grepable con el nombre de allPorts. |

Posteriormente verificamos la versión de los servicios en los puertos abiertos y lanzamos los scripts por defecto.

```text
nmap -sCV -p22,80,8065 delivery.htb -oN targeted
Starting Nmap 7.91 ( https://nmap.org ) at 2021-02-23 00:03 CST
Nmap scan report for delivery.htb (10.10.10.222)
Host is up (0.071s latency).
PORT STATE SERVICE VERSION
22/tcp open ssh OpenSSH 7.9p1 Debian 10+deb10u2 (protocol 2.0)
| ssh-hostkey:
| 2048 9c:40:fa:85:9b:01:ac:ac:0e:bc:0c:19:51:8a:ee:27 (RSA)
| 256 5a:0c:c0:3b:9b:76:55:2e:6e:c4:f4:b9:5d:76:17:09 (ECDSA)
|_ 256 b7:9d:f7:48:9d:a2:f2:76:30:fd:42:d3:35:3a:80:8c (ED25519)
80/tcp open http nginx 1.14.2
|_http-server-header: nginx/1.14.2
|_http-title: Welcome
8065/tcp open unknown
| fingerprint-strings:
| GenericLines, Help, RTSPRequest, SSLSessionReq, TerminalServerCookie:
| HTTP/1.1 400 Bad Request
| Content-Type: text/plain; charset=utf-8
| Connection: close
| Request
| GetRequest:
| HTTP/1.0 200 OK
| Accept-Ranges: bytes
| Cache-Control: no-cache, max-age=31556926, public
| Content-Length: 3108
| Content-Security-Policy: frame-ancestors 'self'; script-src 'self' cdn.rudderlabs.com
| Content-Type: text/html; charset=utf-8
| Last-Modified: Mon, 22 Feb 2021 17:16:35 GMT
| X-Frame-Options: SAMEORIGIN
| X-Request-Id: u37rs8frebrw9p9yfsr51qsfqo
| X-Version-Id: 5.30.0.5.30.1.57fb31b889bf81d99d8af8176d4bbaaa.false
| Date: Tue, 23 Feb 2021 06:06:48 GMT
| <!doctype html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=0"><meta name="robots" con
tent="noindex, nofollow"><meta name="referrer" content="no-referrer"><title>Mattermost</title><meta name="mobile-web-app-capable" content="yes"><meta name="application-name" content="Matt
ermost"><meta name="format-detection" content="telephone=no"><link re
| HTTPOptions:
| HTTP/1.0 405 Method Not Allowed
| Date: Tue, 23 Feb 2021 06:06:48 GMT
|_ Content-Length: 0
```

| Bandera | Descripción |
| :--- | :--- |
| -p22,80,8065 | Escaneo a los puertos 22, 80 y 8065. |
| -sC | Escanea con los scripts por defecto. |
| -sV | Intenta determinar la versión del servicio que se ejecuta en el puerto. |
| -oN | Exporta los resultados en un formato nmap. |

Lo primero que hice es buscar directorios en la página web, pero no hay nada interesante.

```text
# python3 dirsearch.py -u http://delivery.htb/
[19:20:28] 200 - 648B - /README.MD
[19:20:42] 301 - 185B - /assets -> http://delivery.htb/assets/
[19:20:42] 403 - 571B - /assets/
[19:20:50] 301 - 185B - /error -> http://delivery.htb/error/
[19:20:50] 200 - 1KB - /error/
[19:20:53] 301 - 185B - /images -> http://delivery.htb/images/
[19:20:53] 403 - 571B - /images/
[19:20:54] 200 - 11KB - /index.html
```

Primero agregamos host virtual en el archivo /etc/hosts.

```text
# echo "10.10.10.222 delivery.htb" >> /etc/hosts
```

Visitando el servidor web delivery.htb e interactuando vemos que hay una redirección a helpdesk.delivery.htb. En el código fuente no hay mucha información.

![](../../.gitbook/assets/1%20%284%29.png)

Agregamos host virtual en el archivo /etc/hosts.

```text
# echo "10.10.10.222 helpdesk.delivery.htb" >> /etc/hosts
```

Después volví a buscar mas directioners pero la mayoria eran códigos de estado 40x y las redirecciones iban a la página principal.

```text
# python3 dirsearch.py -u http://helpdesk.delivery.htb/
[19:32:17] 301 - 185B - /js -> http://helpdesk.delivery.htb/js/
[19:32:31] 200 - 36KB - /account.php
[19:32:33] 403 - 571B - /admin/includes/configure.php~
[19:32:39] 403 - 571B - /administrator/includes/
[19:32:40] 400 - 17B - /ajax.php
[19:32:40] 302 - 0B - /api/ -> ../
[19:32:40] 301 - 185B - /api -> http://helpdesk.delivery.htb/api/
[19:32:41] 301 - 185B - /apps -> http://helpdesk.delivery.htb/apps/
[19:32:41] 403 - 571B - /apps/
[19:32:41] 403 - 571B - /assets/
[19:32:41] 301 - 185B - /assets -> http://helpdesk.delivery.htb/assets/
[19:32:47] 301 - 185B - /css -> http://helpdesk.delivery.htb/css/
[19:32:54] 403 - 571B - /images/
[19:32:54] 301 - 185B - /images -> http://helpdesk.delivery.htb/images/
[19:32:54] 200 - 5KB - /index.php
[19:32:57] 422 - 5KB - /login.php
[19:32:58] 302 - 13B - /logout.php -> index.php
[19:32:58] 200 - 63B - /manage.php
[19:33:01] 301 - 185B - /pages -> http://helpdesk.delivery.htb/pages/
[19:33:06] 422 - 5KB - /profile.php
[19:33:15] 200 - 5KB - /view.php
[19:33:16] 200 - 2KB - /web.config
```

Existe un login de administración pero está deshabilitado.

![](../../.gitbook/assets/2%20%2812%29.png)

Tenemos acceso al login, lo primero que hice fue intentar registrarme.

![](../../.gitbook/assets/3%20%2810%29.png)

No hay alguna manera de registrarse pero sí de abrir un ticket.

![](../../.gitbook/assets/4.png)

Al abrir un ticket, lo lleno con datos ficticios y envió el ticket.

![](../../.gitbook/assets/5%20%2810%29.png)

Al mandar el ticket nos regresa la siguiente información. Llegado a este punto, recordé que había un aplicativo en el puerto 8065, http://delivery.htb:8065/.

![](../../.gitbook/assets/6%20%2815%29.png)

Consultado el ticket.

![](../../.gitbook/assets/7%20%287%29.png)

Visitando delivery.htb:8065, vemos que se trata de mattermost servicio de chat en línea de código abierto y autohospedable con intercambio de archivos, búsqueda e integraciones. Está diseñado como un chat interno para organizaciones y empresas.

Al momento de registrarte en mattermost, se envía un correo de confirmación, pero no es posible acceder a este.

![](../../.gitbook/assets/8%20%289%29.png)

Después de un largo rato \(días\) probar algunas combinaciones, a continuación los pasos para recibir correctamente el correo de confirmación para poder acceder al servicio.

1. Creamos un ticket en [http://helpdesk.delivery.htb/open.php](http://helpdesk.delivery.htb/open.php), al igual que otros ejercicios suelo utilizar el dominio MAQUINA.htb para registrarme en cualquier web. En este caso el dato más importante es el correo. Por si acaso anoté todo lo que puse: correo:test-gaze@delivery.htb.
2. Esto me devolvió el siguiente correo 9912350@delivery.htb el cual se crea automáticamente cuando se crea un ticket con un, id único. Por lo tanto ahora tenemos un correo que pertenece al dominio de la organización.
3. En mattermost, debemos registrarnos con un correo que pertenece a la organización, osease 9912350@delivery.htb, se enviará un correo de confirmación al correo registrado, este correo llega como mensaje en helpdesk. Como menciona al momento de crear el ticket, si deseamos agregar más información, podemos enviar al id@correo que se creó, por lo tanto el correo de confirmación nos llega.

![](../../.gitbook/assets/9%20%286%29.png)

## Punto de acceso

Entramos al equipo internal.

![](../../.gitbook/assets/10%20%284%29.png)

Al entrar, si leemos un poco el usuario root está publicando las siguientes credenciales maildeliverer:Youve\_G0t\_Mail!.![](../../.gitbook/assets/11.png)

Estas son las credenciales para conectarse por ssh.

![](../../.gitbook/assets/12%20%283%29.png)

Buscando en la carpeta de instalación de mattermost en /opt en los archivos de configuración podemos ver que existe un archivo config.json el cual contiene los valores más importantes.

{% embed url="https://docs.mattermost.com/administration/config-settings.html" %}

{% embed url="https://docs.mattermost.com/install/trouble\_mysql.html" %}

Podemos ver que se lista un usuario y una contraseña.

```text
"SqlSettings": {
 "DriverName": "mysql",
 "DataSource": "mmuser:Crack_The_MM_Admin_PW@tcp(127.0.0.1:3306)/mattermost?charset=utf8mb4,utf8\u0026readTimeout=30s\u0026writeTimeout=30s",
 "DataSourceReplicas": [],
 "DataSourceSearchReplicas": [],
 "MaxIdleConns": 20,
 "ConnMaxLifetimeMilliseconds": 3600000,
 "MaxOpenConns": 300,
 "Trace": false,
 "AtRestEncryptKey": "n5uax3d4f919obtsp1pw1k5xetq1enez",
 "QueryTimeout": 30,
 "DisableDatabaseSearch": false
 },
```

Nos conectamos a la base de datos y nos vamos directo a los usuarios y contraseñas

![](../../.gitbook/assets/13.png)

```text
> show database;
> show tables;
> select * from Users;
```

![](../../.gitbook/assets/14.png)

```text
select Username,Password from Users;
```

![](../../.gitbook/assets/15%20%283%29.png)

Ahora necesitamos crackear la contraseña.

```text
root:$2a$10$VM6EeymRxJ29r8Wjkr8Dtev0O.1STWb4.4ScG.anuu7v0EFJwgjjO
```

Nos mencionan que la contraseña puede no estar en rockyou y que usemos reglas hashcat para romper facilmente, con la variante de “PleaseSubscribe!”

![](../../.gitbook/assets/16%20%284%29.png)

## Escalada de privilegios

Primero identificamos el hash.

![](../../.gitbook/assets/17%20%283%29.png)

Buscamos el número del tipo de hash.

```text
# hashcat --help | grep bcrypt
 3200 | bcrypt $2*$, Blowfish (Unix) | Operating System
```

Iniciamos el ataque. Ya solo faltaría esperar...

```text
# hashcat -a 0 -m 3200 hash directorio -r /usr/share/hashcat/rules/best64.rule
```

Después de unos 2 breves minutos.

![](../../.gitbook/assets/18%20%281%29.png)

Accediendo a root.

![](../../.gitbook/assets/19%20%282%29.png)

