---
description: https://www.hackthebox.eu/home/machines/profile/351
---

# Cap

Máquina Linux con tres puertos abiertos 21:ftp, 22:ssh y 80:http, en la que se exponen descargas de capturas de red, las cuales contienen contraseñas en texto plano para ingresar al sistema. Posteriormente hacemos uso de las capabilities para llegar a root.

![](<../../.gitbook/assets/image (117).png>)

## Enumeración

### Nmap

Realizamos un escaneo con nmap para saber los puertos abiertos en el rango de 1-65536 puertos.

```
# Nmap 7.80 scan initiated Sun Sep 12 19:48:30 2021 as: nmap -p- --open -n -T5 -v -oG allPorts 10.10.10.245
# Ports scanned: TCP(65535;1-65535) UDP(0;) SCTP(0;) PROTOCOLS(0;)
Host: 10.10.10.245 () Status: Up
Host: 10.10.10.245 () Ports: 21/open/tcp//ftp///, 22/open/tcp//ssh///, 80/open/tcp//http/// Ignored State: closed (65532)
# Nmap done at Sun Sep 12 19:48:48 2021 -- 1 IP address (1 host up) scanned in 17.53 second
```

| Bandera      | Descripción                                                                  |
| ------------ | ---------------------------------------------------------------------------- |
| -p-          | Escaneo a los 65536 puertos                                                  |
| --open       | Reporta solo los puertos con estado "open".                                  |
| -T5          | Exploracion a velocidades insanas (lo hago porque es un entorno de pruebas). |
| -v           | Muestra más información sobre el sondeo que se está realizando.              |
| -oG allPorts | Exporta los resultados en un formato Grepable con el nombre de allPorts.     |

Posteriormente verificamos la versión de los servicios en los puertos abiertos y lanzamos los scripts por defecto.

```
# Nmap 7.92 scan initiated Sun Sep 12 15:13:53 2021 as: nmap -sCV -p21,22,80 -oN targeted 10.10.10.245
Nmap scan report for 10.10.10.245
Host is up (0.054s latency).
PORT STATE SERVICE VERSION
21/tcp open ftp vsftpd 3.0.3
22/tcp open ssh OpenSSH 8.2p1 Ubuntu 4ubuntu0.2 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey:
| 3072 fa:80:a9:b2:ca:3b:88:69:a4:28:9e:39:0d:27:d5:75 (RSA)
| 256 96:d8:f8:e3:e8:f7:71:36:c5:49:d5:9d:b6:a4:c9:0c (ECDSA)
|_ 256 3f:d0:ff:91:eb:3b:f6:e1:9f:2e:8d:de:b3:de:b2:18 (ED25519)
80/tcp open http gunicorn
|_http-title: Security Dashboard
| fingerprint-strings:
| FourOhFourRequest:
| HTTP/1.0 404 NOT FOUND
| Server: gunicorn
| Date: Sun, 12 Sep 2021 20:14:03 GMT
| Connection: close
| Content-Type: text/html; charset=utf-8
| Content-Length: 232
| <!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
| <title>404 Not Found</title>
| <h1>Not Found</h1>
| <p>The requested URL was not found on the server. If you entered the URL manually please check your spelling and try again.</p>
| GetRequest:
| HTTP/1.0 200 OK
| Server: gunicorn
| Date: Sun, 12 Sep 2021 20:13:58 GMT
| Connection: close
| Content-Type: text/html; charset=utf-8
| Content-Length: 19386
| <!DOCTYPE html>
| <html class="no-js" lang="en">
| <head>
| <meta charset="utf-8">
| <meta http-equiv="x-ua-compatible" content="ie=edge">
| <title>Security Dashboard</title>
| <meta name="viewport" content="width=device-width, initial-scale=1">
| <link rel="shortcut icon" type="image/png" href="/static/images/icon/favicon.ico">
| <link rel="stylesheet" href="/static/css/bootstrap.min.css">
| <link rel="stylesheet" href="/static/css/font-awesome.min.css">
| <link rel="stylesheet" href="/static/css/themify-icons.css">
| <link rel="stylesheet" href="/static/css/metisMenu.css">
| <link rel="stylesheet" href="/static/css/owl.carousel.min.css">
| <link rel="stylesheet" href="/static/css/slicknav.min.css">
| <!-- amchar
| HTTPOptions:
| HTTP/1.0 200 OK
| Server: gunicorn
| Date: Sun, 12 Sep 2021 20:13:58 GMT
| Connection: close
| Content-Type: text/html; charset=utf-8
| Allow: GET, OPTIONS, HEAD
| Content-Length: 0
| RTSPRequest:
| HTTP/1.1 400 Bad Request
| Connection: close
| Content-Type: text/html
| Content-Length: 196
| <html>
| <head>
| <title>Bad Request</title>
| </head>
| <body>
| <h1><p>Bad Request</p></h1>
| Invalid HTTP Version &#x27;Invalid HTTP Version: &#x27;RTSP/1.0&#x27;&#x27;
| </body>
|_ </html>
|_http-server-header: gunicorn
1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
SF-Port80-TCP:V=7.92%I=7%D=9/12%Time=613E5F87%P=x86_64-pc-linux-gnu%r(GetR
SF:equest,105F,"HTTP/1\.0\x20200\x20OK\r\nServer:\x20gunicorn\r\nDate:\x20
SF:Sun,\x2012\x20Sep\x202021\x2020:13:58\x20GMT\r\nConnection:\x20close\r\
SF:nContent-Type:\x20text/html;\x20charset=utf-8\r\nContent-Length:\x20193
SF:86\r\n\r\n<!DOCTYPE\x20html>\n<html\x20class=\"no-js\"\x20lang=\"en\">\
SF:n\n<head>\n\x20\x20\x20\x20<meta\x20charset=\"utf-8\">\n\x20\x20\x20\x2
SF:0<meta\x20http-equiv=\"x-ua-compatible\"\x20content=\"ie=edge\">\n\x20\
SF:x20\x20\x20<title>Security\x20Dashboard</title>\n\x20\x20\x20\x20<meta\
SF:x20name=\"viewport\"\x20content=\"width=device-width,\x20initial-scale=
SF:1\">\n\x20\x20\x20\x20<link\x20rel=\"shortcut\x20icon\"\x20type=\"image
SF:/png\"\x20href=\"/static/images/icon/favicon\.ico\">\n\x20\x20\x20\x20<
SF:link\x20rel=\"stylesheet\"\x20href=\"/static/css/bootstrap\.min\.css\">
SF:\n\x20\x20\x20\x20<link\x20rel=\"stylesheet\"\x20href=\"/static/css/fon
SF:t-awesome\.min\.css\">\n\x20\x20\x20\x20<link\x20rel=\"stylesheet\"\x20
SF:href=\"/static/css/themify-icons\.css\">\n\x20\x20\x20\x20<link\x20rel=
SF:\"stylesheet\"\x20href=\"/static/css/metisMenu\.css\">\n\x20\x20\x20\x2
SF:0<link\x20rel=\"stylesheet\"\x20href=\"/static/css/owl\.carousel\.min\.
SF:css\">\n\x20\x20\x20\x20<link\x20rel=\"stylesheet\"\x20href=\"/static/c
SF:ss/slicknav\.min\.css\">\n\x20\x20\x20\x20<!--\x20amchar")%r(HTTPOption
SF:s,B3,"HTTP/1\.0\x20200\x20OK\r\nServer:\x20gunicorn\r\nDate:\x20Sun,\x2
SF:012\x20Sep\x202021\x2020:13:58\x20GMT\r\nConnection:\x20close\r\nConten
SF:t-Type:\x20text/html;\x20charset=utf-8\r\nAllow:\x20GET,\x20OPTIONS,\x2
SF:0HEAD\r\nContent-Length:\x200\r\n\r\n")%r(RTSPRequest,121,"HTTP/1\.1\x2
SF:0400\x20Bad\x20Request\r\nConnection:\x20close\r\nContent-Type:\x20text
SF:/html\r\nContent-Length:\x20196\r\n\r\n<html>\n\x20\x20<head>\n\x20\x20
SF:\x20\x20<title>Bad\x20Request</title>\n\x20\x20</head>\n\x20\x20<body>\
SF:n\x20\x20\x20\x20<h1><p>Bad\x20Request</p></h1>\n\x20\x20\x20\x20Invali
SF:d\x20HTTP\x20Version\x20&#x27;Invalid\x20HTTP\x20Version:\x20&#x27;RTSP
SF:/1\.0&#x27;&#x27;\n\x20\x20</body>\n</html>\n")%r(FourOhFourRequest,189
SF:,"HTTP/1\.0\x20404\x20NOT\x20FOUND\r\nServer:\x20gunicorn\r\nDate:\x20S
SF:un,\x2012\x20Sep\x202021\x2020:14:03\x20GMT\r\nConnection:\x20close\r\n
SF:Content-Type:\x20text/html;\x20charset=utf-8\r\nContent-Length:\x20232\
SF:r\n\r\n<!DOCTYPE\x20HTML\x20PUBLIC\x20\"-//W3C//DTD\x20HTML\x203\.2\x20
SF:Final//EN\">\n<title>404\x20Not\x20Found</title>\n<h1>Not\x20Found</h1>
SF:\n<p>The\x20requested\x20URL\x20was\x20not\x20found\x20on\x20the\x20ser
SF:ver\.\x20If\x20you\x20entered\x20the\x20URL\x20manually\x20please\x20ch
SF:eck\x20your\x20spelling\x20and\x20try\x20again\.</p>\n");
Service Info: OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel
Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done at Sun Sep 12 15:16:04 2021 -- 1 IP address (1 host up) scanned in 131.15 seconds
```

| Bandera    | Descripción                                                             |
| ---------- | ----------------------------------------------------------------------- |
| -p21,22,80 | Escaneo a los puertos 21 22 y 80.                                       |
| -sC        | Escanea con los scripts por defecto.                                    |
| -sV        | Intenta determinar la versión del servicio que se ejecuta en el puerto. |
| -oN        | Exporta los resultados en un formato nmap.                              |

### Web

Podemos ver que es un visor de eventos.

![](<../../.gitbook/assets/0 (16).png>)

Y que existen otras herramientas. Checando más a fondo, las últimas dos secciones no muestran algo que nos pudiera ayudar.

![](<../../.gitbook/assets/1 (16).png>)

En la sección “Security Snapshot (5 Second PCAP + Analysis)”, podemos descargar un pcap (una captura de red), proseguí a descargarla y analizarla, pero no tenía mucha información, al volver a clicar en esta sección, él id cambia y por lo tanto la captura de red también es distinta.

![](<../../.gitbook/assets/2 (16).png>)

Una vez sabiendo esto, realice un script en Python para saber cuáles id son están disponibles y a su vez realizar la descarga de la captura de red.

```python
import requests

def download_files(urls):    
    for rq in range(0,len(urls)):
        print("Descargando archivos en : {}".format(urls[rq]))
        url = "http://10.10.10.245/download/{}".format(rq)
        response = requests.get(url,stream=True)
        with open ("/home/gazette/Documents/Hackthebox/Cap/captura_{}.pcap".format(rq), 'wb') as captura:
            for chunk in response.iter_content(chunk_size=2000):
                captura.write(chunk)

def get_request():    
    urls = []
    for i in range (0,100): 
        url = "http://10.10.10.245/data/{}".format(i)
        print("Realizando peticion a: {}".format(url))
        response = requests.get(url,allow_redirects=False)
        print("Codigo de estado: {}".format(response.status_code))
        if response.status_code == 200:
            urls.append(url)            
        else:
            break
    return urls

def main():
    download_files(urls = get_request())

if __name__ == "__main__":
    main()
```

Solo se descargaron 15 archivos.

![](<../../.gitbook/assets/3 (16).png>)

Los cuales hay que analizarlos, podemos hacerlo de uno por uno o mejor unir las capturas con `mergecap`. En mi caso la captura 5 estaba corrupta, la descargué de manera manual y seguía igual (igualmente no afecto para resolver el ejercicio).

![](<../../.gitbook/assets/4 (16).png>)

## Punto de acceso

### Analizando la captura final (con wireshark).

Abrimos la captura, nos dirimimos a Statistics>Protocol Hierarchy, en esta pestaña podemos ver los protocolos que fueron capturados en la captura.

![](<../../.gitbook/assets/5 (16).png>)

Podemos filtrarlos de la siguiente manera: Clic derecho en el protocolo que deseemos “Apply as FIlter > Selected”, en este caso FTP para verificar que datos se están tramitando, si cerramos esta pestaña vemos solo. Ahora en cualquier frame que deseemos, clic derecho, “Follow > TCP Stream” , verá los datos reales (comprimidos) como una secuencia de bytes. Como FTP no viaja de manera cifrada, podemos visualizar lo que está pasando, en la captura podemos encontrar un usuario y contraseña.

![](<../../.gitbook/assets/6 (16).png>)

Podemos ingresar por FTP, pero no hay nada interesante (más que la bandera), por lo tanto probamos si el usuario y las credenciales funcionan para SSH.

![](<../../.gitbook/assets/7 (16).png>)

## Escalada de privilegios <a href="escalada-de-privilegios" id="escalada-de-privilegios"></a>

Al momento de estar enumerando el sistema me encuentro con que python3.8 tiene asignado el bit setuid, por lo que hemos encontrado la vía para escalar privilegios.

![](<../../.gitbook/assets/8 (14).png>)

Pero si realmente no sabes que son las capabilities dejo un pequeño texto explicando que es y para que pudiera servir.

### Capabilities

#### ¿Que son las capabilities en linux?

Normalmente, el usuario root (o cualquier ID con UID de 0) recibe un tratamiento especial cuando ejecuta procesos. El kernel y las aplicaciones generalmente están programados para omitir la restricción de algunas actividades al ver este ID de usuario. En otras palabras, este usuario puede hacer (casi) cualquier cosa. Las capacidades de Linux proporcionan un subconjunto de los privilegios de root disponibles para un proceso. Esto efectivamente divide los privilegios de root en unidades más pequeñas y distintivas. Cada una de estas unidades se puede otorgar de forma independiente a los procesos. De esta forma se reduce el conjunto completo de privilegios y se disminuyen los riesgos de explotación.

#### ¿Por qué el uso de capabilities?

Para comprender mejor cómo funcionan las capabilities de Linux, echemos un vistazo primero al problema que intenta resolver.

Supongamos que estamos ejecutando un proceso como un usuario normal. Esto significa que no somos privilegiados. Solo podemos acceder a los datos que son de nuestra propiedad, de nuestro grupo o que están marcados para el acceso de todos los usuarios. En algún momento, nuestro proceso necesita un poco más de permisos para cumplir con sus funciones, como abrir un enchufe de red. El problema es que los usuarios normales no pueden abrir un socket, ya que esto requiere permisos de root.

### Solución

#### Reemplazo de setuid con capacidades 

Asignar el bit setuid a los binarios es una forma común de otorgar permisos de root a los programas. Las capacidades de Linux son una gran alternativa para reducir el uso de setuid.

{% embed url="https://linux.die.net/man/7/capabilities" %}

{% embed url="https://wiki.gentoo.org/wiki/Hardened/Overview_of_POSIX_capabilities" %}

### Python setuid

Ahora basta con importar la librería os, establecer el UID en 0 y hacer un spawn de una shell.

![](<../../.gitbook/assets/9 (13).png>)

Más información de la librería os.

{% embed url="https://docs.python.org/3/library/os.html" %}
